<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="parkour.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.10.1/dist/av-min.js"></script>
  <script>
    var savedUser = localStorage.getItem('user');

    AV.init({
      appId: "Mp8cpIMsHcuDLR8RCsroqlII-9Nh9j0Va",
      appKey: "zXBASj13JavcETYw5triHTJb",
      serverURL: "https://mp8cpims.lc-cn-e1-shared.com"
    });

    function saveScore(score) {
      if (score > 0) {
        var user = localStorage.getItem('user') || savedUser;
        if (!user) {
          user = '';
          for (var i = 0; i < 10; i++) {
            user += String.fromCharCode(Math.floor(Math.random() * 26) + 'a'.charCodeAt(0));
          }
          user = prompt("恭喜你获得" + score + "分,请输入用户名上传结果", user) || user;
        }
        if (user) {
          var Score = AV.Object.extend('Score');
          var data = new Score();
          data.set('score', score);
          data.set('user', user);
          data.save().then(function(data) {
            refresh();
          });
          savedUser = user;
          localStorage.setItem('user', user);
        } else {
          refresh();
        }
      }
    }

    function load(result, excludes, callback) {
      var query = new AV.Query('Score');
      if (excludes.length) {
        query.notContainedIn('user', excludes);
      }
      query.addDescending('score');
      query.addAscending('createdAt');
      query.first().then(data => {
        if (data) {
          var user = data.get('user');
          result.push({
            score: data.get('score'),
            user: user
          });
          if (result.length >= 50) {
            callback && callback(result);
          } else {
            excludes.push(user);
            load(result, excludes, callback);
          }
        } else {
          callback && callback(result);
        }
      })
    }

    function refresh() {
      load([], [], function(result) {
        var rank = document.getElementById('rank');
        rank.innerHTML = '';
        for (var i = 0; i < result.length; i++) {
          rank.innerHTML += '<div>' + result[i].user + ':' + result[i].score + '</div>';
        }
      })
    }
  </script>
  <script>
    var parkour;
    function initParkour() {
      parkour = new Parkour('parkour', {
        size: {                 //各尺寸配置
          container: {          //容器尺寸
            width: 400,       
            height: 300
          },
          protagonist: {        //主角尺寸
            width: 16,
            height: 32
          },
          awards: [             //奖品尺寸(多种)
            {
              width: 10,
              height: 15
            }
          ],
          background: {         //背景尺寸
            width: 400
          },
          tile: {               //地块尺寸(所有地块的宽度需要一致)
            width: 32           
          },
          tiles: [              //地块尺寸(不同高度的地块的设置)
            {     
              height: 54
            },
            {     
              height: 36
            },
            {     
              height: 72
            }
          ],
          flags: [
            {
              width: 16,
              height: 32
            },
            {
              width: 16,
              height: 16
            },
            {
              width: 16,
              height: 32
            }
          ]
        },
        assets: {               //各资源的配置
          protagonist: {        //主角资源配置
            staying: 'images/protagonist-staying.png',         //
            running: [          //奔跑动作的帧图片
              'images/protagonist-running-1.png',
              'images/protagonist-running-2.png',
              'images/protagonist-running-3.png'
            ],
            jumping: 'images/protagonist-jumping.png'  //跳跃动作的图片
          },
          background: [         //背景图,(背景滚动时可以多张首尾衔接)
            '....jpg'
          ],
          tiles: [              //地块图片资源
            {
              left: [
                'images/tile-2-left.png'
              ],
              middle: [
                'images/tile-2-middle.png'
              ],
              right: [
                'images/tile-2-right.png'
              ]
            },
            {
              left: [           //左侧地块图片资源(多个时每次随机一个)
                'images/tile-1-left.png'
              ],
              middle: [         //中间地块图片资源(多个时每次随机一个)
                'images/tile-1-middle.png'
              ],
              right: [          //右侧地块图片资源(多个时每次随机一个)
                'images/tile-1-right.png'
              ]
            },
            {
              left: [
                'images/tile-3-left.png'
              ],
              middle: [
                'images/tile-3-middle.png'
              ],
              right: [
                'images/tile-3-right.png'
              ]
            }
          ],
          awards: [
            {
              normal: 'images/award-1.png' //正常状态下的奖品图片
            }
          ],
          flags: [
            [
              'images/flag-1-1.png',
              'images/flag-1-1.png',
              'images/flag-1-2.png',
              'images/flag-1-2.png',
              'images/flag-1-3.png',
              'images/flag-1-3.png'
            ],
            ['images/flag-2.png'],
            ['images/flag-3.png']
          ]
        },
        config: {
          fps: score => Math.min(40, 20 + Math.floor(score / 5)),              //帧率
          protagonist: {        //主角配置
            run: {              //奔跑配置
              start: 100,       //开始位置
              speed: 4          //奔跑速度(可以接受方法作为参数,根据当前的得分和已用时长跳转速度,(score:number,time:number)=>number)
            },
            jump: {             //跳跃配置
              power: 8,         //跳跃力度(px/f)
              gravity: 0.4      //重力加速度(px/f²)
            }
          },
          awards: [             //奖品配置
            {
              score: 1          //奖品获得的积分配置
            }
          ],
          flags: [
            {
              probability: 0.1         //随机出现,概率
            },
            {
              probability: 0.1         //随机出现,概率
            },
            {
              location: 300     //固定位置出现(可以接受方法作为参数,方法返回是否出现,(startLocation:number,endLocation:number)=>boolean)
            }
          ],
          tiles: {
            empty: {
              min: score => Math.min(3, 1 + Math.floor(score / 25)),     //悬崖最小的大小
              max: score => Math.min(4, 2 + Math.floor(score / 20))      //悬崖最大的大小
            },
            land: {
              min: 1,     //陆地最小大小,不含左右地块,只计算中间地块
              max: score => Math.max(4, 10 - Math.floor(score / 25))     //陆地最大大小,不含左右地块,只计算中间地块
            }
          },
          win: {                //胜利条件
            time: Infinity,     //到达指定时间获胜
            score: Infinity     //获得指定积分获胜
          },
          background: {
            speed: 1           //背景卷动的速度
          }
        }
      });
      parkour.onInited = function() {
        
      }
      parkour.onScoreChange = function(score, max) {
        document.getElementById('score').innerHTML = score;
      }
      parkour.onWin = function() {
        alert('获胜');
        saveScore(parkour.score);
        initParkour();
      }
      parkour.onLose = function() {
        alert('游戏结束');
        saveScore(parkour.score);
        initParkour();
      }
    }

    window.onload = function() {
      initParkour();
      document.body.onclick = function() {
        if (parkour.isPlaying()) {
          parkour.jump();
        } else if (parkour.isInited()) {
          parkour.start();
        }
      }
      refresh();
    }
  </script>
</head>
<body onselect="return false" onselectstart="return false" style="user-select: none;">
  <div id="parkour">
    
  </div>
  <div id="score">0</div>
  <div>排行榜:</div>
  <div id="rank"></div>
</body>
</html>